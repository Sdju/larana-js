<!DOCTYPE html>
<html lang="%LANG%">
	<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>%TITLE%</title>
		%META%
		<style>
			html, body, #canvas {
				margin: 0;
				padding: 0;
				width: 100%;
				height: 100%;
				background-color: #333;
				color: #fff;
				overflow: hidden;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<script>
			var canvas = document.getElementById('canvas');
			var ctx = canvas.getContext('2d');

			var resizeTimeout = null;
			var eventTimeout = null;

			var ENDPOINT = '%WS_PATH%';
			var SESSION_ID = '%SESSION_ID%';

			var INITIAL_W = Number('%INITIAL_W%');
			var INITIAL_H = Number('%INITIAL_H%');

			var ws = null;

			function resizeCanvas() {
				canvas.setAttribute('width', window.innerWidth);
				canvas.setAttribute('height', window.innerHeight);
			}

			function drawImage(image, x, y) {
				var img = new Image();

				img.onload = function (e) {
					ctx.drawImage(img, x, y);
				};
				img.src = image;
			}

			function getMessage(e) {
				var data = JSON.parse(e.data);
				drawImage(data.image, data.x, data.y);
			}

			function sendMessage(data) {
				ws.send(JSON.stringify({
					data: data,
					w: window.innerHeight,
					h: window.innerWidth,
					sessionId: SESSION_ID,
				}));
			}

			function delayMessage(data) {
				clearTimeout(eventTimeout);
				eventTimeout = setTimeout(function() {
					sendMessage(data);
				}, 100);
			}

			function connect() {
				ws = new WebSocket(ENDPOINT);
				ws.onmessage = function (e) {
					getMessage(e);
				};
				ws.onopen = function (e) {
					ws.send(JSON.stringify({
						data: {
							event: 'open',
						},
						w: window.innerWidth,
						h: window.innerHeight,
						sessionId: SESSION_ID,
					}));
				};
			}

			window.addEventListener('resize', function () {
				clearTimeout(resizeTimeout);
				resizeTimeout = setTimeout(function() {
					resizeCanvas();
				}, 100);
			});

			window.addEventListener('click', function (e) {
				// delayMessage({
				sendMessage({
					event: 'click',
					y: e.clientY,
					x: e.clientX,
				});
			});

			window.addEventListener('mousemove', function (e) {
				delayMessage({
					event: 'mousemove',
					y: e.clientY,
					x: e.clientX,
				});
			});

			window.addEventListener('keypress', function (e) {
				delayMessage({
					event: 'keypress',
					value: e.key,
				});
			});

			document.addEventListener('DOMContentLoaded', function () {
				resizeCanvas();
				drawImage(
					'%INITIAL_DRAW%',
					(window.innerWidth / 2) - (INITIAL_W / 2),
					(window.innerHeight / 2) - (INITIAL_H / 2),
				);
				connect();
			});
		</script>
		%SCRIPTS%
	</body>
</html>
